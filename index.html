<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>å¬å†™è½¯ä»¶ Dictation</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: "PingFang SC", "Microsoft YaHei", "Helvetica Neue", Arial, sans-serif;
      background: linear-gradient(135deg, #dbeafe 0%, #ede9fe 50%, #fce7f3 100%);
      background-attachment: fixed;
      color: #1a202c;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 28px 16px;
    }

    h1 {
      font-size: 2rem;
      font-weight: 800;
      background: linear-gradient(135deg, #3b82f6, #8b5cf6);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 28px;
      letter-spacing: 0.05em;
    }

    .app {
      width: 100%;
      max-width: 720px;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    /* â”€â”€ Card â”€â”€ */
    .card {
      background: rgba(255, 255, 255, 0.85);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border-radius: 24px;
      box-shadow: 0 8px 32px rgba(99, 102, 241, 0.1), 0 2px 8px rgba(0,0,0,0.06);
      border: 1px solid rgba(255, 255, 255, 0.7);
      padding: 24px;
    }
    .card h2 {
      font-size: 1.05rem;
      font-weight: 700;
      color: #5a67d8;
      margin-bottom: 16px;
    }

    /* â”€â”€ Input area â”€â”€ */
    .input-row {
      display: flex;
      gap: 8px;
      margin-bottom: 10px;
    }
    .input-row input {
      flex: 1;
      border: 1.5px solid #e2e8f0;
      border-radius: 14px;
      padding: 10px 14px;
      font-size: 1rem;
      outline: none;
      transition: border-color .2s, box-shadow .2s;
      background: rgba(255,255,255,0.9);
    }
    .input-row input:focus {
      border-color: #7c3aed;
      box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.12);
    }

    textarea {
      width: 100%;
      height: 110px;
      border: 1.5px solid #e2e8f0;
      border-radius: 14px;
      padding: 12px 14px;
      font-size: 0.95rem;
      resize: vertical;
      outline: none;
      transition: border-color .2s, box-shadow .2s;
      font-family: inherit;
      background: rgba(255,255,255,0.9);
    }
    textarea:focus {
      border-color: #7c3aed;
      box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.12);
    }

    .hint {
      font-size: 0.78rem;
      color: #94a3b8;
      margin-top: 6px;
    }

    /* â”€â”€ Buttons â”€â”€ */
    button {
      cursor: pointer;
      border: none;
      border-radius: 12px;
      font-size: 0.95rem;
      font-family: inherit;
      font-weight: 600;
      padding: 10px 20px;
      transition: background .2s, transform .15s, box-shadow .2s;
    }
    button:active { transform: scale(0.97) !important; }
    button:disabled { opacity: .45; cursor: not-allowed; transform: none !important; box-shadow: none !important; }

    .btn-primary {
      background: linear-gradient(135deg, #4299e1, #667eea);
      color: #fff;
      box-shadow: 0 4px 14px rgba(102, 126, 234, 0.35);
    }
    .btn-primary:hover:not(:disabled) {
      background: linear-gradient(135deg, #3182ce, #553cf4);
      box-shadow: 0 6px 18px rgba(102, 126, 234, 0.45);
      transform: translateY(-1px);
    }

    .btn-success {
      background: linear-gradient(135deg, #48bb78, #4fd1c5);
      color: #fff;
      box-shadow: 0 4px 14px rgba(72, 187, 120, 0.35);
    }
    .btn-success:hover:not(:disabled) {
      background: linear-gradient(135deg, #38a169, #38b2ac);
      box-shadow: 0 6px 18px rgba(72, 187, 120, 0.45);
      transform: translateY(-1px);
    }

    .btn-warning {
      background: linear-gradient(135deg, #ed8936, #ecc94b);
      color: #fff;
      box-shadow: 0 4px 14px rgba(237, 137, 54, 0.35);
    }
    .btn-warning:hover:not(:disabled) {
      background: linear-gradient(135deg, #dd6b20, #d69e2e);
      box-shadow: 0 6px 18px rgba(237, 137, 54, 0.45);
      transform: translateY(-1px);
    }

    .btn-danger {
      background: linear-gradient(135deg, #fc8181, #f687b3);
      color: #fff;
      box-shadow: 0 4px 14px rgba(252, 129, 129, 0.35);
    }
    .btn-danger:hover:not(:disabled) {
      background: linear-gradient(135deg, #f56565, #ed64a6);
      box-shadow: 0 6px 18px rgba(252, 129, 129, 0.45);
      transform: translateY(-1px);
    }

    .btn-gray { background: #edf2f7; color: #4a5568; }
    .btn-gray:hover:not(:disabled) { background: #e2e8f0; transform: translateY(-1px); }

    .btn-mic {
      background: linear-gradient(135deg, #ebf8ff, #e0e7ff);
      color: #4c51bf;
      border: 1.5px solid #c3dafe;
      padding: 10px 14px;
      user-select: none;
      -webkit-user-select: none;
    }
    .btn-mic.listening {
      background: linear-gradient(135deg, #fed7d7, #fbb6ce);
      color: #c53030;
      border-color: #feb2b2;
      animation: pulse 1s infinite;
    }
    @keyframes pulse {
      0%,100% { box-shadow: 0 0 0 0 rgba(252,129,129,.5); }
      50%      { box-shadow: 0 0 0 8px rgba(252,129,129,0); }
    }

    /* â”€â”€ Settings row â”€â”€ */
    .settings-row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
    }
    .settings-row label {
      font-size: 0.88rem;
      color: #4a5568;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .settings-row select, .settings-row input[type="number"] {
      border: 1.5px solid #e2e8f0;
      border-radius: 10px;
      padding: 6px 10px;
      font-size: 0.88rem;
      font-family: inherit;
      outline: none;
      background: rgba(255,255,255,0.9);
      transition: border-color .2s;
    }
    .settings-row select:focus, .settings-row input:focus { border-color: #7c3aed; }
    .settings-row input[type="number"] { width: 62px; }
    .settings-row input[type="range"] {
      -webkit-appearance: none;
      width: 80px;
      height: 5px;
      border-radius: 4px;
      background: #c3dafe;
      outline: none;
      border: none;
      padding: 0;
      cursor: pointer;
    }
    .settings-row input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea, #764ba2);
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(102, 126, 234, 0.4);
    }
    .settings-row input[type="range"]::-moz-range-thumb {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea, #764ba2);
      cursor: pointer;
      border: none;
    }
    .settings-row .val-badge {
      font-size: 0.8rem;
      color: #5a67d8;
      font-weight: 600;
      min-width: 2.2em;
      text-align: center;
    }

    /* â”€â”€ Word list â”€â”€ */
    #word-list {
      list-style: none;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      max-height: 130px;
      overflow-y: auto;
      padding: 4px 0;
    }
    #word-list li {
      background: linear-gradient(135deg, #ebf8ff, #e0e7ff);
      border: 1px solid #c3dafe;
      border-radius: 999px;
      padding: 5px 14px;
      font-size: 0.88rem;
      color: #4c51bf;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    #word-list li .remove-btn {
      cursor: pointer;
      color: #a0aec0;
      font-size: 0.8rem;
      font-weight: 700;
      line-height: 1;
      background: none;
      border: none;
      padding: 0;
      font-family: inherit;
      box-shadow: none;
    }
    #word-list li .remove-btn:hover { color: #e53e3e; transform: none; box-shadow: none; }
    #word-list li.active-word {
      background: linear-gradient(135deg, #fefcbf, #fbd38d);
      border-color: #f6ad55;
      color: #744210;
    }

    /* â”€â”€ Dictation stage â”€â”€ */
    #dictation-stage {
      text-align: center;
      padding: 10px 0;
    }

    .progress-bar-wrap {
      background: #e8edf5;
      border-radius: 999px;
      height: 10px;
      margin-bottom: 24px;
      overflow: hidden;
    }
    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, #667eea, #48bb78, #4fd1c5, #667eea);
      background-size: 300% 100%;
      border-radius: 999px;
      transition: width .5s ease;
      animation: progressShimmer 3s infinite linear;
    }
    @keyframes progressShimmer {
      0%   { background-position: 100% 0; }
      100% { background-position: 0% 0; }
    }

    .current-index {
      font-size: 0.9rem;
      color: #94a3b8;
      margin-bottom: 12px;
      letter-spacing: 0.03em;
    }

    .word-display-wrap {
      background: linear-gradient(135deg, rgba(224,231,255,0.5), rgba(199,246,255,0.5));
      border-radius: 20px;
      padding: 24px 40px;
      display: inline-block;
      min-width: 200px;
      margin-bottom: 8px;
    }
    .word-display {
      font-size: 3rem;
      font-weight: 800;
      color: #2d3748;
      min-height: 72px;
      display: flex;
      align-items: center;
      justify-content: center;
      letter-spacing: 0.05em;
    }
    .word-display.hidden-word {
      filter: blur(14px);
      user-select: none;
    }
    @keyframes wordPop {
      0%   { opacity: 0; transform: scale(0.75); }
      60%  { opacity: 1; transform: scale(1.08); }
      100% { opacity: 1; transform: scale(1); }
    }
    .word-display.pop { animation: wordPop 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); }

    .dict-controls {
      display: flex;
      gap: 10px;
      justify-content: center;
      flex-wrap: wrap;
      margin-top: 24px;
    }
    .dict-controls button { min-width: 90px; }

    .status-badge {
      display: inline-block;
      margin-top: 16px;
      font-size: 0.82rem;
      padding: 6px 16px;
      border-radius: 999px;
      background: linear-gradient(135deg, #ebf8ff, #e0e7ff);
      color: #4c51bf;
      box-shadow: 0 2px 8px rgba(99, 102, 241, 0.12);
    }
    .status-badge.speaking {
      background: linear-gradient(135deg, #f0fff4, #c6f6d5);
      color: #276749;
    }
    .status-badge.listening {
      background: linear-gradient(135deg, #fff5f5, #fed7d7);
      color: #c53030;
    }

    /* â”€â”€ Action row â”€â”€ */
    .action-row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    /* â”€â”€ Result panel â”€â”€ */
    #result-panel {
      display: none;
      padding: 24px;
      background: linear-gradient(135deg, #f0fff4, #e0f2fe);
      border: 1px solid rgba(154, 230, 180, 0.5);
      border-radius: 20px;
      text-align: center;
    }
    #result-panel h3 {
      font-size: 1.3rem;
      color: #276749;
      margin-bottom: 8px;
    }
    #result-panel p { color: #2f855a; font-size: 0.95rem; }

    .section-sep { border: none; border-top: 1px solid rgba(99, 102, 241, 0.1); margin: 16px 0; }

    /* scrollbar */
    #word-list::-webkit-scrollbar { width: 6px; }
    #word-list::-webkit-scrollbar-track { background: transparent; }
    #word-list::-webkit-scrollbar-thumb { background: #c3dafe; border-radius: 3px; }
  </style>
</head>
<body>
  <h1>ğŸ“ å¬å†™è½¯ä»¶ Dictation</h1>

  <div class="app">

    <!-- â‘  Word Input -->
    <div class="card" id="input-panel">
      <h2>â‘  è¾“å…¥è¯è¯­ Add Words</h2>

      <!-- Single word + voice -->
      <div class="input-row">
        <input type="text" id="single-input" placeholder="è¾“å…¥ä¸€ä¸ªè¯è¯­ï¼ŒæŒ‰ Enter æ·»åŠ â€¦" />
        <button class="btn-mic" id="mic-btn" title="ç‚¹å‡»å¼€å§‹/åœæ­¢è¯­éŸ³è¾“å…¥">ğŸ¤ ç‚¹å‡»è¯´è¯</button>
        <button class="btn-primary" id="add-btn">æ·»åŠ </button>
      </div>

      <!-- Batch paste -->
      <textarea id="batch-input" placeholder="æ‰¹é‡è¾“å…¥ï¼šæ¯è¡Œä¸€ä¸ªè¯ï¼Œæˆ–ç”¨é€—å·/ç©ºæ ¼åˆ†éš”ï¼Œç„¶åç‚¹å‡»ã€Œå¯¼å…¥ã€&#10;è‹¹æœ&#10;é¦™è•‰&#10;æ©™å­"></textarea>
      <div class="hint">æ¯è¡Œä¸€è¯ï¼Œæˆ–ä»¥é€—å· / ç©ºæ ¼åˆ†éš” Â· One word per line or comma/space separated</div>
      <div class="action-row" style="margin-top:10px;">
        <button class="btn-primary" id="import-btn">å¯¼å…¥ Import</button>
        <button class="btn-danger"  id="clear-words-btn">æ¸…ç©º Clear</button>
      </div>

      <hr class="section-sep" />

      <h2 style="margin-bottom:10px;">è¯è¯­åˆ—è¡¨ Word List <span id="word-count" style="font-weight:400;color:#a0aec0;">(0)</span></h2>
      <ul id="word-list"></ul>
    </div>

    <!-- â‘¡ Settings -->
    <div class="card">
      <h2>â‘¡ è®¾ç½® Settings</h2>
      <div class="settings-row">
        <label>
          é¡ºåº Order:
          <select id="order-select">
            <option value="sequential">é¡ºåº Sequential</option>
            <option value="random">ä¹±åº Random</option>
          </select>
        </label>
        <label>
          è¯­è¨€ Language:
          <select id="lang-select">
            <option value="zh-CN">ä¸­æ–‡ Chinese</option>
            <option value="en-US">English</option>
            <option value="zh-TW">ç¹é«”ä¸­æ–‡</option>
          </select>
        </label>
        <label>
          æ¯è¯æœ—è¯»æ¬¡æ•° Repeats:
          <input type="number" id="repeat-input" value="1" min="1" max="5" />
        </label>
        <label style="display:flex;align-items:center;gap:6px;">
          <input type="checkbox" id="hide-word-chk" />
          éšè—è¯ Hide word
        </label>
        <label>
          æœ—è¯»é€Ÿåº¦:
          <select id="rate-select">
            <option value="0.7">æ…¢ Slow</option>
            <option value="1" selected>æ­£å¸¸ Normal</option>
            <option value="1.3">å¿« Fast</option>
            <option value="1.6">å¾ˆå¿« Very Fast</option>
            <option value="2.0">æå¿« Extra Fast</option>
            <option value="3.0">æœ€å¿« Max Fast</option>
          </select>
        </label>
        <label>
          å‘éŸ³äºº Voice:
          <select id="voice-select">
            <option value="">é»˜è®¤ Default</option>
          </select>
        </label>
        <label>
          éŸ³è°ƒ Pitch:
          <input type="range" id="pitch-range" min="0.5" max="2" step="0.1" value="1.1"
                 aria-label="éŸ³è°ƒ Pitch" />
          <span class="val-badge" id="pitch-val">1.1</span>
        </label>
        <label>
          éŸ³é‡ Volume:
          <input type="range" id="vol-range" min="0" max="1" step="0.1" value="1"
                 aria-label="éŸ³é‡ Volume" />
          <span class="val-badge" id="vol-val">1.0</span>
        </label>
        <label style="display:flex;align-items:center;gap:6px;">
          <input type="checkbox" id="auto-play-chk" />
          è‡ªåŠ¨è¿ç»­æ’­æ”¾ Auto-play
        </label>
        <label id="auto-play-interval-label">
          é—´éš”(ç§’) Interval:
          <input type="number" id="interval-input" value="1" min="0" max="10" step="0.5" aria-label="è¯è¯­é—´éš”ç§’æ•° Interval between words in seconds" />
        </label>
      </div>
    </div>

    <!-- â‘¢ Dictation -->
    <div class="card">
      <h2>â‘¢ å¬å†™ Dictation</h2>

      <div class="action-row" style="margin-bottom:14px;">
        <button class="btn-success" id="start-btn">â–¶ å¼€å§‹ Start</button>
        <button class="btn-warning" id="replay-btn" disabled>ğŸ”Š é‡æ’­ Replay</button>
        <button class="btn-gray"    id="stop-btn"   disabled>â¹ åœæ­¢ Stop</button>
      </div>

      <div id="dictation-stage" style="display:none;">
        <div class="progress-bar-wrap">
          <div class="progress-bar" id="progress-bar" style="width:0%"></div>
        </div>
        <div class="current-index" id="current-index">â€” / â€”</div>
        <div class="word-display-wrap">
          <div class="word-display" id="word-display">â€”</div>
        </div>
        <div id="status-badge" class="status-badge">å‡†å¤‡ä¸­â€¦</div>

        <div class="dict-controls">
          <button class="btn-gray"    id="prev-btn">â—€ ä¸Šä¸€ä¸ª</button>
          <button class="btn-primary" id="next-btn">ä¸‹ä¸€ä¸ª â–¶</button>
          <button class="btn-mic"     id="voice-next-btn" title="è¯­éŸ³å‘½ä»¤"
                  style="display:none;">ğŸ¤ è¯­éŸ³ç¿»é¡µ</button>
        </div>
      </div>

      <div id="result-panel">
        <h3>ğŸ‰ å¬å†™å®Œæˆï¼All Done!</h3>
        <p id="result-msg"></p>
      </div>
    </div>

  </div><!-- .app -->

  <script>
  (() => {
    'use strict';

    // â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let words        = [];   // original word list
    let playlist     = [];   // ordered / shuffled copy used for current session
    let currentIdx   = -1;
    let running      = false;
    let synth        = window.speechSynthesis;
    let voiceNextRec = null; // SpeechRecognition for "next" voice command
    let micRec       = null; // SpeechRecognition for word input

    // â”€â”€ Element refs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const singleInput    = document.getElementById('single-input');
    const micBtn         = document.getElementById('mic-btn');
    const addBtn         = document.getElementById('add-btn');
    const batchInput     = document.getElementById('batch-input');
    const importBtn      = document.getElementById('import-btn');
    const clearWordsBtn  = document.getElementById('clear-words-btn');
    const wordList       = document.getElementById('word-list');
    const wordCount      = document.getElementById('word-count');

    const orderSelect    = document.getElementById('order-select');
    const langSelect     = document.getElementById('lang-select');
    const repeatInput    = document.getElementById('repeat-input');
    const hideWordChk    = document.getElementById('hide-word-chk');
    const rateSelect     = document.getElementById('rate-select');
    const voiceSelect    = document.getElementById('voice-select');
    const pitchRange     = document.getElementById('pitch-range');
    const pitchVal       = document.getElementById('pitch-val');
    const volRange       = document.getElementById('vol-range');
    const volVal         = document.getElementById('vol-val');
    const autoPlayChk    = document.getElementById('auto-play-chk');
    const intervalInput  = document.getElementById('interval-input');

    const startBtn       = document.getElementById('start-btn');
    const replayBtn      = document.getElementById('replay-btn');
    const stopBtn        = document.getElementById('stop-btn');
    const dictStage      = document.getElementById('dictation-stage');
    const progressBar    = document.getElementById('progress-bar');
    const currentIndexEl = document.getElementById('current-index');
    const wordDisplay    = document.getElementById('word-display');
    const statusBadge    = document.getElementById('status-badge');
    const prevBtn        = document.getElementById('prev-btn');
    const nextBtn        = document.getElementById('next-btn');
    const voiceNextBtn   = document.getElementById('voice-next-btn');
    const resultPanel    = document.getElementById('result-panel');
    const resultMsg      = document.getElementById('result-msg');

    // â”€â”€ Speech Recognition availability â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const SpeechRecognition =
      window.SpeechRecognition || window.webkitSpeechRecognition;
    const hasSpeechRec = !!SpeechRecognition;

    if (!hasSpeechRec) {
      micBtn.disabled = true;
      micBtn.title = 'æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ« / Browser not supported';
      voiceNextBtn.style.display = 'none';
    } else {
      voiceNextBtn.style.display = '';
    }

    // â”€â”€ Voice population â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function populateVoices() {
      const voices = synth.getVoices();
      const lang = langSelect.value;
      const langPrefix = lang.split('-')[0];
      const filtered = voices.filter(v =>
        v.lang.startsWith(langPrefix) || v.lang === lang
      );
      const prev = voiceSelect.value;
      voiceSelect.innerHTML = '<option value="">é»˜è®¤ Default</option>';
      filtered.forEach(v => {
        const opt = document.createElement('option');
        opt.value = v.name;
        const mark = v.localService === false ? ' âœ¨' : '';
        opt.textContent = `${v.name} (${v.lang})${mark}`;
        voiceSelect.appendChild(opt);
      });
      // Restore previous selection or auto-pick a non-local (neural/online) voice
      const prevExists = Array.from(voiceSelect.options).some(o => o.value === prev);
      if (prev && prevExists) {
        voiceSelect.value = prev;
      } else {
        const neural = filtered.find(v => v.localService === false);
        if (neural) voiceSelect.value = neural.name;
      }
    }
    if (typeof synth.onvoiceschanged !== 'undefined') {
      synth.addEventListener('voiceschanged', populateVoices);
    }
    populateVoices();
    langSelect.addEventListener('change', populateVoices);

    pitchRange.addEventListener('input', () => {
      pitchVal.textContent = pitchRange.value;
    });
    volRange.addEventListener('input', () => {
      volVal.textContent = parseFloat(volRange.value).toFixed(1);
    });

    // â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function shuffle(arr) {
      const a = [...arr];
      for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }

    function setStatus(text, cls) {
      statusBadge.textContent = text;
      statusBadge.className = 'status-badge' + (cls ? ' ' + cls : '');
    }

    function renderWordList() {
      wordList.innerHTML = '';
      words.forEach((w, i) => {
        const li = document.createElement('li');
        li.dataset.idx = i;
        li.innerHTML = `<span>${w}</span>`;
        const rb = document.createElement('button');
        rb.className = 'remove-btn';
        rb.textContent = 'âœ•';
        rb.title = 'åˆ é™¤';
        rb.addEventListener('click', () => removeWord(i));
        li.appendChild(rb);
        wordList.appendChild(li);
      });
      wordCount.textContent = `(${words.length})`;
      startBtn.disabled = words.length === 0;
    }

    function removeWord(idx) {
      words.splice(idx, 1);
      renderWordList();
    }

    function addWords(raw) {
      const tokens = raw
        .split(/[\n,ï¼Œã€\s]+/)
        .map(s => s.trim())
        .filter(Boolean);
      tokens.forEach(t => {
        if (!words.includes(t)) words.push(t);
      });
      renderWordList();
    }

    // â”€â”€ Word input events â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    addBtn.addEventListener('click', () => {
      const v = singleInput.value.trim();
      if (v) { addWords(v); singleInput.value = ''; singleInput.focus(); }
    });

    singleInput.addEventListener('keydown', e => {
      if (e.key === 'Enter') addBtn.click();
    });

    importBtn.addEventListener('click', () => {
      const v = batchInput.value.trim();
      if (v) { addWords(v); batchInput.value = ''; }
    });

    clearWordsBtn.addEventListener('click', () => {
      if (words.length === 0) return;
      if (confirm('ç¡®è®¤æ¸…ç©ºæ‰€æœ‰è¯è¯­ï¼Ÿ')) { words = []; renderWordList(); }
    });

    // â”€â”€ Mic input for adding words (click-to-toggle) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let micListening = false;

    function startMicRecording() {
      if (!hasSpeechRec || micListening) return;
      micRec = new SpeechRecognition();
      micRec.lang = langSelect.value;
      micRec.interimResults = true;
      micRec.maxAlternatives = 1;
      micRec.continuous = true;

      micRec.onstart = () => {
        micListening = true;
        micBtn.classList.add('listening');
        micBtn.textContent = 'ğŸ”´ ç‚¹å‡»åœæ­¢';
      };
      micRec.onresult = e => {
        for (let i = e.resultIndex; i < e.results.length; i++) {
          const transcript = e.results[i][0].transcript.trim();
          if (e.results[i].isFinal) {
            singleInput.value = '';
            if (transcript) {
              // Split by whitespace / Chinese punctuation so each spoken word
              // becomes a separate entry; fall back to the whole transcript as one word.
              const tokens = transcript.split(/[\s,ï¼Œã€ã€‚ï¼ï¼Ÿ\u3000]+/).filter(Boolean);
              const wordsSet = new Set(words);
              tokens.forEach(t => {
                if (!wordsSet.has(t)) { words.push(t); wordsSet.add(t); }
              });
              renderWordList();
            }
          } else {
            singleInput.value = transcript;
          }
        }
      };
      micRec.onerror = e => {
        if (e.error !== 'no-speech') {
          setStatus(`è¯­éŸ³è¾“å…¥å‡ºé”™: ${e.error}`, '');
        }
      };
      micRec.onend = () => {
        // Auto-restart to keep listening until user clicks stop
        if (micListening && micRec) {
          try { micRec.start(); } catch (e) { console.warn('micRec restart:', e); }
        } else {
          micBtn.classList.remove('listening');
          micBtn.textContent = 'ğŸ¤ ç‚¹å‡»è¯´è¯';
        }
      };
      micRec.start();
    }

    function stopMicRecording() {
      micListening = false;
      if (micRec) {
        try { micRec.stop(); } catch (e) { console.warn('stopMic:', e); }
        micRec = null;
      }
    }

    micBtn.addEventListener('click', () => {
      if (micListening) { stopMicRecording(); } else { startMicRecording(); }
    });

    // â”€â”€ Dictation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function buildPlaylist() {
      playlist = orderSelect.value === 'random' ? shuffle(words) : [...words];
    }

    function startDictation() {
      if (words.length === 0) return;
      buildPlaylist();
      currentIdx = -1;
      running = true;

      resultPanel.style.display = 'none';
      dictStage.style.display = 'block';
      startBtn.disabled  = true;
      stopBtn.disabled   = false;
      replayBtn.disabled = false;
      prevBtn.disabled   = true;
      nextBtn.disabled   = false;

      goNext();
    }

    function stopDictation() {
      running = false;
      synth.cancel();
      stopVoiceNext();
      startBtn.disabled  = false;
      stopBtn.disabled   = true;
      replayBtn.disabled = true;
      setStatus('å·²åœæ­¢ Stopped');
      highlightActiveWord(-1);
    }

    function finishDictation() {
      running = false;
      synth.cancel();
      stopVoiceNext();
      dictStage.style.display = 'none';
      resultPanel.style.display = 'block';
      resultMsg.textContent = `å…±å®Œæˆ ${playlist.length} ä¸ªè¯è¯­çš„å¬å†™ï¼`;
      startBtn.disabled  = false;
      stopBtn.disabled   = true;
      replayBtn.disabled = true;
      highlightActiveWord(-1);
    }

    function updateProgress() {
      const pct = playlist.length
        ? Math.round(((currentIdx + 1) / playlist.length) * 100)
        : 0;
      progressBar.style.width = pct + '%';
      currentIndexEl.textContent = `ç¬¬ ${currentIdx + 1} / ${playlist.length} ä¸ª`;
      prevBtn.disabled = currentIdx <= 0;
      nextBtn.disabled = currentIdx >= playlist.length - 1;
    }

    function showWord(word) {
      wordDisplay.textContent = word;
      wordDisplay.classList.remove('pop');
      // Access offsetWidth to trigger a reflow, restarting the CSS animation
      void wordDisplay.offsetWidth;
      wordDisplay.classList.add('pop');
      if (hideWordChk.checked) {
        wordDisplay.classList.add('hidden-word');
      } else {
        wordDisplay.classList.remove('hidden-word');
      }
    }

    function speakWord(word, onDone) {
      synth.cancel();
      const repeats = parseInt(repeatInput.value, 10) || 1;
      const rate    = parseFloat(rateSelect.value) || 1;
      const lang    = langSelect.value;
      const pitch   = parseFloat(pitchRange.value) || 1;
      const volume  = parseFloat(volRange.value) || 1;
      const voices  = synth.getVoices();
      const voice   = voices.find(v => v.name === voiceSelect.value) || null;

      let count = 0;
      function speakOnce() {
        const utt = new SpeechSynthesisUtterance(word);
        utt.lang   = lang;
        utt.rate   = rate;
        utt.pitch  = pitch;
        utt.volume = volume;
        if (voice) utt.voice = voice;
        utt.onstart = () => setStatus(`ğŸ”Š æœ—è¯»ä¸­â€¦ "${word}"`, 'speaking');
        utt.onend = () => {
          count++;
          if (count < repeats) {
            setTimeout(speakOnce, 400);
          } else {
            setStatus('ç­‰å¾…ä¸‹ä¸€ä¸ªâ€¦ Waiting for next', '');
            onDone && onDone();
          }
        };
        utt.onerror = () => { onDone && onDone(); };
        synth.speak(utt);
      }
      speakOnce();
    }

    function highlightActiveWord(playlistIndex) {
      document.querySelectorAll('#word-list li').forEach(li => li.classList.remove('active-word'));
      if (playlistIndex < 0) return;
      const word = playlist[playlistIndex];
      const origIdx = words.indexOf(word);
      if (origIdx >= 0) {
        const li = wordList.querySelector(`li[data-idx="${origIdx}"]`);
        if (li) {
          li.classList.add('active-word');
          li.scrollIntoView({ block: 'nearest' });
        }
      }
    }

    function playCurrentWord() {
      const word = playlist[currentIdx];
      showWord(word);
      updateProgress();
      highlightActiveWord(currentIdx);
      const onDone = autoPlayChk.checked
        ? () => {
            const delay = Math.max(0, parseFloat(intervalInput.value) || 0) * 1000;
            setTimeout(() => { if (running) goNext(); }, delay);
          }
        : null;
      speakWord(word, onDone);
    }

    function goNext() {
      if (!running) return;
      if (currentIdx >= playlist.length - 1) {
        finishDictation();
        return;
      }
      currentIdx++;
      playCurrentWord();
    }

    function goPrev() {
      if (!running || currentIdx <= 0) return;
      currentIdx--;
      playCurrentWord();
    }

    startBtn.addEventListener('click', startDictation);
    stopBtn.addEventListener('click', stopDictation);
    nextBtn.addEventListener('click', () => { if (running) goNext(); });
    prevBtn.addEventListener('click', () => { if (running) goPrev(); });
    replayBtn.addEventListener('click', () => {
      if (running && currentIdx >= 0) playCurrentWord();
    });

    // â”€â”€ Voice "next" command â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let voiceNextListening = false;

    function stopVoiceNext() {
      if (voiceNextRec) {
        try { voiceNextRec.stop(); } catch(e) { console.warn('stopVoiceNext:', e); }
        voiceNextRec = null;
      }
      voiceNextListening = false;
      voiceNextBtn.classList.remove('listening');
      voiceNextBtn.textContent = 'ğŸ¤ è¯­éŸ³ç¿»é¡µ';
    }

    function startVoiceNext() {
      if (!hasSpeechRec) return;
      voiceNextRec = new SpeechRecognition();
      voiceNextRec.lang = langSelect.value;
      voiceNextRec.interimResults = true;
      voiceNextRec.continuous = true;

      const actedIndices = new Set();

      voiceNextRec.onstart = () => {
        voiceNextListening = true;
        voiceNextBtn.classList.add('listening');
        voiceNextBtn.textContent = 'ğŸ¤ åœæ­¢è¯­éŸ³';
        setStatus('ğŸ¤ è¯­éŸ³ç›‘å¬ä¸­â€¦', 'listening');
      };
      voiceNextRec.onresult = e => {
        for (let i = e.resultIndex; i < e.results.length; i++) {
          if (actedIndices.has(i)) continue;
          const t = e.results[i][0].transcript.trim().toLowerCase();
          if (t.includes('ä¸‹ä¸€ä¸ª') || t.includes('next') || t.includes('ä¸‹ä¸€') || t.includes('ç»§ç»­')) {
            goNext();
            actedIndices.add(i);
          } else if (t.includes('ä¸Šä¸€ä¸ª') || t.includes('previous') || t.includes('ä¸Šä¸€') || t.includes('back')) {
            goPrev();
            actedIndices.add(i);
          } else if (t.includes('é‡æ’­') || t.includes('replay') || t.includes('å†è¯´ä¸€é')) {
            if (running && currentIdx >= 0) playCurrentWord();
            actedIndices.add(i);
          }
        }
      };
      voiceNextRec.onerror = e => {
        if (e.error !== 'no-speech') setStatus(`è¯­éŸ³å‘½ä»¤å‡ºé”™: ${e.error}`, '');
      };
      voiceNextRec.onend = () => {
        // auto-restart if still supposed to be listening
        if (voiceNextListening && running) {
          actedIndices.clear();
          try { voiceNextRec.start(); } catch(e) { console.warn('voiceNext restart:', e); }
        }
      };
      voiceNextRec.start();
    }

    voiceNextBtn.addEventListener('click', () => {
      if (voiceNextListening) {
        stopVoiceNext();
        setStatus('ç­‰å¾…ä¸‹ä¸€ä¸ªâ€¦ Waiting for next', '');
      } else {
        startVoiceNext();
      }
    });

    // â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    renderWordList();
  })();
  </script>
</body>
</html>
